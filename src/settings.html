<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <title>StreamElements - Activity Feed</title>
        <script>
            if (typeof module === 'object') {
                window.module = module;
                module = undefined;
            }
        </script>
        <script src="jquery-3.1.1.min.js"></script>
        <script>
            if (window.module) module = window.module;
        </script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="../node_modules/material-design-lite/material.min.css">
        <script src="../node_modules/material-design-lite/material.min.js"></script>
        <!-- mdl-selectfield -->   
        <link rel="stylesheet" href="../node_modules/mdl-selectfield/dist/mdl-selectfield.min.css">
        <script defer src="../node_modules/mdl-selectfield/dist/mdl-selectfield.min.js"></script>
        <!---->
        <link rel="stylesheet" href="settings.css">
        <script>
            const node_fs = require("fs");
            Object.prototype.getKeyByValue = function( value ) {
                for( var prop in this ) {
                    if( this.hasOwnProperty( prop ) ) {
                        if( this[ prop ] === value )
                            return prop;
                    }
                }
            }
        </script>
    </head>
    <body>
        <button id="back" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored"><i class="material-icons">arrow_back</i></button>
        <h3 id="title">Settings</h3>
        <div id="settings">
            <h4>Authentication</h4>

            <!-- JWT -->
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width: calc(100vw - 4.3em);">
                <input class="mdl-textfield__input" type="text" id="jwt" pattern=".{36}\.[^\.]+\.[^\.]+">
                <label class="mdl-textfield__label" for="jwt">Your JWT Token...</label>
            </div>
            <label class="mdl-icon-toggle mdl-js-icon-toggle mdl-js-ripple-effect" for="show-jwt" onclick="if((!$('#jwt').val()) || $('#jwt').val() === '') { return false; }">
                <input type="checkbox" id="show-jwt" class="mdl-icon-toggle__input">
                <i class="mdl-icon-toggle__label material-icons">visibility</i>
            </label>


            <h4>Keybindings</h4>

            <!-- Skip alert -->
            <h6>Skip alert:</h6>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width: 10em;margin-right: 1em;">
                <input class="mdl-textfield__input" type="text" id="skip_K" pattern="(.{1}|F([1-9]|1[0-9]|2[0-4])|Space|Plus|Tab|Backspace|Delete|Insert|Return|Enter|Up|Down|Left|Right|Home|End|PageUp|PageDown|Escape|Esc|VolumeUp|VolumeDown|VolumeMute|MediaNextTrack|MediaPreviousTrack|MediaStop|MediaPlayPause|PrintScreen)">
                <label class="mdl-textfield__label" for="skip_K">Key...</label>
            </div>

            <div class="mdl-selectfield mdl-js-selectfield mdl-selectfield--floating-label" style="width: 10em;">
                <select class="mdl-selectfield__select" id="skip_M">
                    <option value="#">None</option>
                    <option value="Alt+">Alt</option>
                    <option value="CmdOrCtrl+">Control/Command</option>
                    <option value="Shift+">Shift</option>
                </select>
                <div class="mdl-selectfield__icon"><i class="material-icons">arrow_drop_down</i></div>
                <label class="mdl-selectfield__label" for="skip_M">Modifier</label>
            </div>
            <div id="key-info"><a style="cursor: pointer;">Show info about keybindings</a></div>
        </div>
        <a id="version"></a>
        <script>
            // Show keybindings
            $("#key-info").on("click", function() {
                $("#key-info").html(`<a><b>DEPENDING ON YOUR KEYBOARD-LAYOUT SOME COMBINATIONS MAY NOT WORK!</b></a><p style="margin-bottom: 0;">Available keys:</p><ul><li>0 to 9, A to Z, F1 to F24, Punctuations like ~, !, @, #, $, etc.</li><li>Plus, Space, Tab, Backspace, Delete, Insert, Return (or Enter as alias)</li><li>Up, Down, Left and Right, Home and End, PageUp and PageDown</li><li>Escape (or Esc for short), VolumeUp, VolumeDown and VolumeMute</li><li>MediaNextTrack, MediaPreviousTrack, MediaStop and MediaPlayPause</li><li>PrintScreen</li></ul>`);
            });

            // Show version
            (function() {
                var pack;
                if (node_fs.existsSync('./package.json')) {
                    pack = JSON.parse(node_fs.readFileSync('./package.json', 'utf8'));
                } else if (node_fs.existsSync('./resources/app/package.json')) {
                    pack = JSON.parse(node_fs.readFileSync('./resources/app/package.json', 'utf8'));
                } else if (node_fs.existsSync('./resources/app.asar')) {
                    pack = JSON.parse(node_fs.readFileSync('./resources/app.asar/package.json', 'utf8'));
                } else {
                    return $("#version p").html("¯\\_(ツ)_/¯");
                }
                $("#version").html("v" + pack.version );
            })();

            // Back button
            $("#back").on("click", function() {
                location.reload();
            });

            // Show token
            $("#show-jwt").prop('checked', true);
            $("#show-jwt").on("change", function() {
                if ($("#show-jwt").prop('checked')) {
                    $("#jwt").prop("disabled", false).removeClass("secret");
                } else {
                    $("#jwt").prop("disabled", true).addClass("secret");
                }
            });
            
            // Load old settings
            if (node_fs.existsSync("./config.json")) {
                var a = JSON.parse(node_fs.readFileSync("./config.json"));
                $("#skip_M").val(a.keys.skip.mod);
                $("#skip_K").val(a.keys.skip.key);
                if (a.token && a.token !== "") {
                    setInterval(function() {
                        $("#jwt").parent().removeClass("is-disabled");
                    }, 10);
                    $("#jwt").prop("disabled", true).addClass("secret").val(a.token);
                    $("#show-jwt").prop('checked', false);
                }
            }

            // Update settings
            function update_S() {
                if ($("#skip_K").val() && $("#skip_K").val() !== "" && $("#skip_K").val().length === 1) {
                    if ($("#skip_K").val() === " ") {
                        $("#skip_K").val("Space");
                    } else if ($("#skip_K").val() === "+") {
                        $("#skip_K").val("Plus");
                    } else {
                        $("#skip_K").val($("#skip_K").val().toLocaleUpperCase());
                    }
                }
                var tmp = {
                    token: "",
                    keys: {
                        skip: {
                            key: "",
                            mod: ""
                        }
                    }
                };
                if(!$("#skip_K").parent().hasClass("is-invalid")) {
                    tmp.keys.skip.key = $("#skip_K").val();
                }
                if(!$("#jwt").parent().hasClass("is-invalid")) {
                    tmp.token = $("#jwt").val();
                }
                tmp.keys.skip.mod = $("#skip_M").val();
                node_fs.writeFileSync("./config.json", JSON.stringify(tmp));
            }

            $("input").bind("property change keyup", update_S);
            $("select").bind("property change keyup", update_S);
        </script>
    </body>
</html>
